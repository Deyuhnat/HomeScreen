<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>User</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <link rel="stylesheet" href="./css/transaction.css">

</head>

<body>
  <div class="container">
    <button id="backButton">Back</button>
    <button class="viewTableButton" onclick="getTransaction('buyer')">View table as Buyer</button>
    <button class="viewTableButton" onclick="getTransaction('seller')">View table as Seller</button>

    <div id="modalTwo" class="modal">
      <div class="modal-content">
        <div class="contact-form">
          <span class="close">&times;</span>
          <form>
            <h2>Edit Transaction</h2>
            <div>
              <span>Status</span>
              <select id="spinner_list_new_status">
                <option value="Cancel">Cancel</option>
                <option value="Pending">Pending</option>
                <option value="Accepted">Accepted</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <span class="submit">Submit</span>
          </form>
        </div>
      </div>
    </div>

    <table id="transaction_table">

    </table>
  </div>
  <script>
    var defaultUID = JSON.parse(localStorage.getItem("user")).id;
    var defaultSID = JSON.parse(localStorage.getItem("user")).id;
    var defaultOtherUserID = 914;
    var idDisplay;
    var editURL;

    document.getElementById("backButton").addEventListener("click", function () {
      window.location.href = "userprofile.html";
    });

    function getTransaction(type) {
      var link = "http://ec2-52-13-116-128.us-west-2.compute.amazonaws.com:8080/api/transaction"

      $.get(link, function (data, status) {
        console.log(data);
        var html = '    <tr>\n' +
          '        <th>ID</th>\n' +
          '        <th>UID</th>\n' +
          '        <th>SID</th>\n' +
          '        <th>Name</th>\n' +
          '        <th>Status</th>\n' +
          '        <th></th>\n' +
          '    </tr>';

        var tableDetail = '';

        for (var i = 0; i < data.length; i++) {
          if (type === 'buyer') {
            var deleteUrl = 'http://ec2-52-13-116-128.us-west-2.compute.amazonaws.com:8080/' + 'api/transaction/' + data[i].id + '/delete';
            tableDetail = '    <tr>\n' +
              '        <td>' + data[i].id + '</td>\n' +
              '        <td>' + data[i].uid + '</td>\n' +
              '        <td>' + data[i].sid + '</td>\n' +
              '        <td>' + data[i].name + '</td>\n' +
              '        <td>' + data[i].status + '</td>\n' +
              '        <td> <button class="btn btn-danger" onclick="confirmDelete(\'' + deleteUrl + '\')">Delete</button></td>\n' +
              '    </tr>';
            if (data[i].uid !== defaultUID) {
              continue;
            }
          }

          if (type === 'seller') {
            var editID = 'edit' + data[i].id
            var editUrl = 'http://ec2-52-13-116-128.us-west-2.compute.amazonaws.com:8080/' + 'api/transaction/' + data[i].id + '/edit';

            tableDetail = '    <tr>\n' +
              '        <td id="id' + data[i].id + '">' + data[i].id + '</td>\n' +
              '        <td id="uid' + data[i].id + '">' + data[i].uid + '</td>\n' +
              '        <td id="sid' + data[i].id + '">' + data[i].sid + '</td>\n' +
              '        <td id="nameId' + data[i].id + '">' + data[i].name + '</td>\n' +
              '        <td>' + data[i].status + '</td>\n' +
              '        <td><button class="button" data-modal="modalTwo" id="' + editID + '" onclick="displayForm(\'' + editUrl + '\',' + data[i].id + ')">Edit</button></td>\n' +
              '    </tr>';
            if (data[i].sid !== defaultSID) {
              continue;
            }
          }
          html = html + tableDetail;
        }
        document.getElementById("transaction_table").innerHTML = html;
      });
    }

    function getTransactionOfOtherUser() {
      var link = "http://ec2-52-13-116-128.us-west-2.compute.amazonaws.com:8080/api/transaction"

      $.get(link, function (data, status) {
        console.log(data);
        var html = '    <tr>\n' +
          '        <th>ID</th>\n' +
          '        <th>UID</th>\n' +
          '        <th>SID</th>\n' +
          '        <th>Name</th>\n' +
          '        <th>Status</th>\n' +
          '        <th></th>\n' +
          '    </tr>';

        var tableDetail = '';

        for (var i = 0; i < data.length; i++) {
          tableDetail = '    <tr>\n' +
            '        <td>' + data[i].id + '</td>\n' +
            '        <td>' + data[i].uid + '</td>\n' +
            '        <td>' + data[i].sid + '</td>\n' +
            '        <td>' + data[i].name + '</td>\n' +
            '        <td>' + data[i].status + '</td>\n' +
            '    </tr>';
          if (data[i].uid !== defaultOtherUserID) {
            continue;
          }
          html = html + tableDetail;
        }
        document.getElementById("transaction_table").innerHTML = html;
      });
    }

    function confirmDelete(deleteLink) {
      if (confirm("Are you sure want to delete") == true) {
        removeTransaction(deleteLink);
      }
    }

    // delete the transaction from the database
    function removeTransaction(deleteURL) {
      $.ajax({

        type: "DELETE",
        url: deleteURL,

        success: function () {
          window.location.reload();
        },

        failure: function (errMsg) {
          console.log(errMsg.toString())
        }
      });
    }

    function submitEditTransaction() {
      var idId = 'id' + idDisplay;
      var uidId = 'uid' + idDisplay;
      var sidId = 'sid' + idDisplay;
      var nameIdId = 'nameId' + idDisplay;

      var id = document.getElementById(idId).innerText;
      var uid = document.getElementById(uidId).innerText;
      var sid = document.getElementById(sidId).innerText;
      var nameId = document.getElementById(nameIdId).innerText;
      var newStatus = document.getElementById('spinner_list_new_status').value;

      editTransaction(editURL, id, uid, sid, nameId, newStatus);
    }

    // edit the transaction from the database
    function editTransaction(editURL, id, uid, sid, newName, newStatus) {
      let data = {
        "id": id,
        "uid": uid,
        "sid": sid,
        "name": newName,
        "status": newStatus
      }

      $.ajax({

        type: "PUT",
        url: editURL,
        contentType: "application/json",
        data: JSON.stringify(data),

        success: function () {
          window.location.reload();
        },

        failure: function (errMsg) {
          console.log(errMsg.toString())
        }
      });
    }

    function displayForm(url, id) {
      idDisplay = id;
      editURL = url;
      document.getElementById("modalTwo").style.display = "block";
    }

    let closeBtns = [...document.querySelectorAll(".close")];
    closeBtns.forEach(function (btn) {
      btn.onclick = function () {
        let modal = btn.closest(".modal");
        modal.style.display = "none";
      };
    });

    let submitBtns = [...document.querySelectorAll(".submit")];
    submitBtns.forEach(function (btn) {
      btn.onclick = function () {
        submitEditTransaction();
        let modal = btn.closest(".modal");
        modal.style.display = "none";
      };
    });
  </script>


</body>

</html>